{% extends "layout.html" %}

{% block title %}{{ _('Projects') }}{% endblock title %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/side-bar-style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/content-style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/project-table-style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dropdownSelection.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/multi-select.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/administration-form.css') }}">

{% endblock stylesheets %}

{% block scripts %}


<script src="{{ url_for('static', filename='js/close-menus.js') }}"></script>
<script src="{{ url_for('static', filename='js/dropdownMenus.js') }}"></script>
<script src="{{ url_for('static', filename='js/multi-select.js') }}"></script>
<script src="{{ url_for('static', filename='js/multiple-text-input.js') }}"></script>

<script src="{{ url_for('static', filename='js/text-input-name-empl-suggestion.js') }}"></script>

<script src="{{ url_for('static', filename='plugin/tinymce/tinymce.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/init-tinymce-administration.js') }}"></script>


{% endblock scripts %}

{% block onReadyCalls %}
   setUpDropdowns();
   setUpMultiSelection();
   setUpMultipleTextInput();
   filterProjects();
{% endblock onReadyCalls %}

{% block body %}


<div style="display:flex;">

    <form class="side-bar" action="{{ url_for('apply_filter_projects') }}" method="get">


        <label>
          {{ _('Search query') }}:
          <input id="SQInput" type="text" class="form-control-sm" name="Search_query" onKeyUp="filterProjects()">
        </label>


        <label class="multi-select">
            {{ _('Type') }}:
            <select id="type" name="Type" onchange="filterProjects()" multiple>
                <option value="0" >{{ _('All') }}</option>

                 <script>
                    var iter = 0;
                </script>

                 {% for type in r_types %}

                 <option value="" id="noValueType">{{ type }}</option>

                 <script>
                    iter++;
                    document.getElementById("noValueType").setAttribute("value", iter.toString(10));
                    document.getElementById("noValueType").removeAttribute("id");
                </script>


                 {% endfor %}
            </select>
        </label>

        <label class="multi-select">
            {{ _('Disciplines') }}:
            <select id="disciplines" name="Disciplines" onchange="filterProjects()" multiple>
                <option value="0" >{{ _('All') }}</option>

                <script>
                    var iter = 0;
                </script>

                {% for discip in r_disciplines %}

                <option value="" id="noValueDis">{{ discip }}</option>

                <script>
                    iter++;
                    document.getElementById("noValueDis").setAttribute("value", iter.toString(10));
                    document.getElementById("noValueDis").removeAttribute("id");
                </script>

                {% endfor %}

            </select>
        </label>




        <label class="dropdown">
            {{ _('Research group') }}:
            <select id="researchGroup" name="Research_group" onchange="filterProjects()">
                <option value="0">{{ _('All') }}</option>


                <script>
                    iter = 0;
                </script>

                {% for group in r_researchGroups %}

                <option value="" id="noValue">{{ group.name }}</option>

                <script>
                    iter++;
                    document.getElementById("noValue").setAttribute("value", iter.toString(10));
                    document.getElementById("noValue").removeAttribute("id");
                </script>

                {% endfor %}

            </select>
        </label>


        <label class="dropdown">
            {{ _('Status') }}:
            <select id="status" name="Status" onchange="filterProjects()">
                <option value="0">{{ _('All') }}</option>
                <option value="1">{{ _('Available projects only') }}</option>
                <option value="2">{{ _('Assigned projects only') }}</option>
            </select>
        </label>

        <input type="submit" value="{{ _('Search') }}">

    </form>


    <!-- Vanaf hier komen de projecten -->

    <div class="page-content">
        <h1>{{ _('Projects') }}</h1>

          {% if 'admin' in current_user.roles %}

             <button class="page-content-button" data-toggle="modal" data-target="#modal-form-project">{{ _('add project') }}</button>

             <div id="modal-form-project" class="modal fade" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <form id="add-project-form" class="modal-body administration-form" action="" method="post">
                            <label for="administration-form-title">{{ _('Title') }}:</label>
                            <input type="text" id="administration-form-title" name="Title">

                            <label for="administration-form-max">{{ _('Maxstudents') }}:</label>
                            <input type="number" id="administration-form-max" name="Maxstudents">

                            <label for="administration-form-researchgroup">{{ _('Research group') }}:</label>
                            <div class="dropdown input-block">
                                <select name="Researchgroup" id="administration-form-researchgroup">

                                     <script>
                                        iter = 0;
                                     </script>

                                     {% for group in r_researchGroups %}

                                     <option value="" id="noGroupName">{{ group.name }}</option>

                                     <script>
                                        document.getElementById("noGroupName").setAttribute("value", iter.toString(10));
                                        document.getElementById("noGroupName").removeAttribute("id");
                                        iter++;
                                     </script>

                                     {% endfor %}

                                </select>
                            </div>

                            <label for="administration-form-description">{{ _('description') }}:</label>
                            <div class="administration-form-textarea input-block">
                                <textarea class="tinymce" id="administration-form-description" name="Description"></textarea>
                            </div>

                            <label for="administration-form-type">{{ _('Type') }}:</label>
                            <div class="multi-select input-block">
                                <select id="administration-form-type" name="Type">
                                    <option value="0" >{{ _('All') }}</option>

                                     <script>
                                        iter = 0;
                                     </script>

                                     {% for type in r_types %}

                                     <option value="" id="noType">{{ type }}</option>

                                     <script>
                                        iter++;
                                        document.getElementById("noType").setAttribute("value", iter.toString(10));
                                        document.getElementById("noType").removeAttribute("id");
                                    </script>

                                     {% endfor %}
                                </select>
                            </div>

                            <div class="multi-text-input" id="Promotors">
                                <label for="administration-form-promotor">{{ _('Promotors') }}:</label>

                                <div class="input-block">

                                    <div class="suggestion-block">
                                        <input type="text" id="administration-form-promotor" name="Promotor">
                                        <div id="administration-form-promotor-suggestions" class="dropdown-items dropdown-hide text-suggestion-input-dropdown"></div>
                                        <script>setUpNameSuggestions($("#administration-form-promotor"), $("#administration-form-promotor-suggestions"))</script>
                                    </div>

                                    <button id="administration-form-promotor-add">{{ _('add') }}</button>
                                    <script>setUpOnlyAcceptNames($("#administration-form-promotor"), $("#administration-form-promotor-add"))</script>
                                </div>
                            </div>


                            <div class="multi-text-input" id="Tags">
                                <label for="administration-form-tags">{{ _('Tags') }}:</label>

                                <div class="input-block">

                                    <input type="text" id="administration-form-tags" name="Tags">
                                    <button>{{ _('add') }}</button>
                                </div>
                            </div>

                            <label for="administration-form-related">{{ _('Related projects') }}</label>
                            <input type="text" id="administration-form-related" name="Related">

                            <input class="administration-form-submit" type="submit" value="{{ _('Enter') }}">
                        </form>
                    </div>
                </div>
            </div>

         {% endif %}

        <table id="project_list" class="content-table project-table">
            <!--wordt gebruikt om te positioneren-->
        </table>

    </div>

</div>

<script type="text/javascript">

    var Data  = {{alt|tojson|safe}};
    obj = JSON.parse(Data);

    var k = 0;
    {% for project in r_projects %}

    obj[k].href ="{{ url_for('project_page', id=project.ID) }}";
    k++;

    {% endfor %}

    function countOccurances(str, search){
        return (str.match( new RegExp(search, "gi")) || []).length;
    }

    function filterProjects(){

        var searchQ = document.getElementById("SQInput").value;

        // Init
        var result = obj;
        var sq = searchQ.trim();
        var tokens = sq.split(" ");
        var tokenCount = [];
        var totalTokenCount = [];
        var tokenProjectCount = [];

        for( var i in tokens) {
            tokenProjectCount[i] = 0;
            totalTokenCount[i] = 0;
            tokenCount[i] = [];
        }

        // Count Occurances
        for ( var i in result){
            result[i].relevance = 0;
            for( var j in tokens) {

                // Check in title
                if (countOccurances(result[i].title, tokens[j])) {
                    result[i].relevance ++;

                }

                // Check in description
                var count = 0;
                for (word in result[i].words){
                    if (countOccurances(word, tokens[j]) > 0){
                        count += result[i].words[word];
                    }
                }

                tokenCount[j][i] = count;   // tokenCount for this project

                if (count > 0){
                    totalTokenCount[j] += count;    // total token count
                    tokenProjectCount[j] += 1;
                }

            }
        }

        var status = document.getElementById("status");
        var rg = document.getElementById("researchGroup");
        var ms = document.getElementsByClassName("multi-select");

        // get selected types
        var selectedTypes = [];
        for(var i = 0; i < ms[0].children[2].children.length; i++){
            if (!ms[0].children[2].children[i].className.includes("not-selected")){
                selectedTypes.push(ms[0].children[2].children[i].textContent);
            }
        }

        // get selected disciplines
        var selectedDisciplines = [];
        for(var i = 0; i < ms[1].children[2].children.length; i++){
            if (!ms[1].children[2].children[i].className.includes("not-selected")){
                selectedDisciplines.push(ms[1].children[2].children[i].textContent);
            }
        }
        /*
        console.log(selectedTypes);
        console.log(selectedDisciplines);
        console.log(rg.options[rg.selectedIndex].text);
        console.log(status.options[status.selectedIndex].text);
        */

        // Weighted relevance for each token
        for ( var i in result){
            if (!selectedDisciplines.includes("All") && !selectedDisciplines.includes(result[i].discipline) ){
                result[i].relevance = 0;
                continue;
            }
            if (!selectedTypes.includes("All") && !selectedTypes.includes(result[i].type) ){
                result[i].relevance = 0;
                continue;
            }

            var rgFound = false;
            for (var rgn in result[i].researchGroup){
                if (result[i].researchGroup[rgn] == rg.options[rg.selectedIndex].text){
                    rgFound = true;
                    break;
                }

            }

            if (!rgFound && rg.selectedIndex>0){
                result[i].relevance = 0;
                continue;
            }

            switch (status.selectedIndex) {
                case 1:
                    if (result[i].maxStudents <= result[i].registeredStudents){
                        result[i].relevance = 0;
                        continue;
                    }
                    break;
                case 2:
                    if (result[i].maxStudents > result[i].registeredStudents){
                        result[i].relevance = 0;
                        continue;
                    }
                    break;
            }

            for( var j in tokens) {
                if (tokenCount[j][i] && tokenProjectCount[j] !== 0){

                    result[i].relevance += tokenCount[j][i] / totalTokenCount[j] / tokenProjectCount[j];
                }
            }

        }

        // Sort by relevance
        result.sort(function(a, b){return b.relevance - a.relevance});

        // Update page content
        var doc = document.getElementById("project_list");
        doc.innerHTML =
            '<tr>' +
                '<th class="th-1">{{ _('title') }}</th>' +
                '<th class="th-2">{{ _('research group') }}</th>' +
                '<th class="th-3">{{ _('assigned students') }}</th>' +
            '</tr>';

        for (var i in result) {
            if (result[i].relevance == 0){break;}

            doc.innerHTML += '<tr>' +
                '<td><a href=' + result[i].href  + '>' + result[i].title + '</a></td>' +
                '<td>' + result[i].researchGroup + '</td>' +
                '<td>[' + result[i].registeredStudents + ' / ' + result[i].maxStudents + ']</td> ' + // todo: replace 0 by an parameter
                '</tr>' ;

        }
    }

</script>


{% endblock body %}